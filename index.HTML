<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ì½”ì¸ì„±ì í‘œ - ë‚˜ì˜ ì½”ì¸ ë§¤ë§¤ ê¸°ë¡ì¥ </title>

  <!-- PWA / íŒŒë¹„ì½˜ -->
  <link rel="icon" type="image/png" href="logo11.png" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />
  <meta name="theme-color" content="#0f172a" />
  <link rel="manifest" href="manifest.webmanifest" />

  <!-- Libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root { --safe-bottom: env(safe-area-inset-bottom); }
    .glass { background: white; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .tab-item.active { color: #0ea5e9; }
    .ios-safe { padding-bottom: calc(88px + var(--safe-bottom)); }
    #tabbar { display:block !important; height:64px; }
    .fab { box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 text-slate-900">
  <!-- Top App Bar -->
  <header class="sticky top-0 z-30 bg-white/70 border-b border-slate-200/60 backdrop-blur">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-center gap-3">
      <img src="logo.png" alt="CoinPnL Logo" class="h-8" />
      <div class="ml-auto flex items-center gap-2">
        <button id="exportXlsxBtn" class="px-3 py-1.5 rounded-xl bg-emerald-600 text-white text-sm">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
      </div>
    </div>
  </header>

  <!-- Pages Wrapper -->
  <main class="max-w-3xl mx-auto px-4 pt-4 pb-28 ios-safe space-y-4" id="pages">
    <!-- Equity summary -->
    <div class="glass rounded-2xl p-4 flex justify-between items-center">
      <div class="flex-1">
        <div class="text-xs text-slate-500">ì´ ìì‚° (Net)</div>
        <div id="netEquity" class="text-2xl font-bold tracking-tight text-emerald-600">-</div>
      </div>
      <div class="flex-1">
        <div class="text-xs text-slate-500">ì‹œì‘ ìì‚° (Initial)</div>
        <div id="initialEquityView" class="text-lg font-semibold">-</div>
      </div>
      <button id="togglePrivacy" class="ml-3 px-3 py-2 text-2xl hover:bg-slate-100 rounded-lg transition-colors">ğŸ‘ï¸</button>
    </div>

    <!-- Journal Page -->
    <section data-page="journal" class="space-y-4">
      <div class="glass rounded-2xl p-4">
        <h1 class="text-lg font-semibold">ë‚˜ì˜ ë§¤ë§¤ì¼ê¸°</h1>
        <p class="text-sm text-slate-500 mt-1">ì˜¤ëŠ˜ì˜ ë§¤ë§¤ ê¸°ë¡ì„ ê°„ë‹¨íˆ ë‚¨ê²¨ë³´ì„¸ìš” âœï¸</p>
      </div>

      <details class="glass rounded-2xl p-4">
        <summary class="cursor-pointer font-medium">ì„¤ì •</summary>
        <div class="grid grid-cols-1 sm:grid-cols-4 gap-3 mt-3 items-end">
          <div>
            <label class="text-xs text-slate-500">ê¸°ì¤€ í†µí™”</label>
            <select id="ccy" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300 bg-white">
              <option value="USDT">USDT</option>
              <option value="KRW">KRW</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-slate-500">ì´ˆê¸° ìë³¸</label>
            <input id="initialEquity" type="number" step="0.01" placeholder="10000" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300 bg-white" />
          </div>
          <button id="saveSettings" class="px-4 py-2 rounded-xl bg-slate-900 text-white text-sm">ì €ì¥</button>
        </div>
      </details>

      <!-- Quick Entry -->
      <section class="glass rounded-2xl p-4">
        <h2 class="font-semibold mb-3">ë¹ ë¥¸ ì…ë ¥</h2>
        <form id="entryForm" class="grid grid-cols-2 sm:grid-cols-6 gap-3">
          <input required id="date" type="date" class="col-span-2 px-3 py-2 rounded-xl border border-slate-300 bg-white" />
          <div class="col-span-2 grid grid-cols-2 gap-2">
            <select id="tickerPreset" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">
              <option value="">í‹°ì»¤ ì„ íƒ</option>
              <option>BTC/USDT</option>
              <option>ETH/USDT</option>
              <option>SOL/USDT</option>
              <option>XRP/USDT</option>
              <option>BNB/USDT</option>
              <option value="__custom">ì§ì ‘ ì…ë ¥</option>
            </select>
            <div>
              <input id="symbol" list="tickerList" placeholder="ì˜ˆ: BTC/USDT" class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white" />
              <datalist id="tickerList"></datalist>
            </div>
          </div>
          <select id="side" class="col-span-1 px-3 py-2 rounded-xl border border-slate-300 bg-white">
            <option value="LONG">ë¡±</option>
            <option value="SHORT">ìˆ</option>
          </select>
          <input required id="pnl" type="number" step="0.01" placeholder="ì†ìµ" class="col-span-1 px-3 py-2 rounded-xl border border-slate-300 bg-white" />
          <input id="reason" placeholder="ë§¤ë§¤ ê·¼ê±°" class="col-span-2 sm:col-span-6 px-3 py-2 rounded-xl border border-slate-300 bg-white" />
          <div class="col-span-2 sm:col-span-6 flex gap-2">
            <button class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:scale-105 transition-transform" type="submit">ì¶”ê°€</button>
            <button class="px-4 py-2 rounded-xl border border-slate-300" type="button" id="clearForm">í¼ ì§€ìš°ê¸°</button>
          </div>
        </form>
        <p class="mt-2 text-xs text-slate-500">â€¢ ë“œë¡­ë‹¤ìš´ì—ì„œ ì„ íƒí•˜ê±°ë‚˜ ì…ë ¥ì°½ì— <b>ì§ì ‘ ì…ë ¥</b>í•  ìˆ˜ ìˆì–´ìš”.</p>
      </section>

      <!-- Table -->
      <section class="glass rounded-2xl p-2">
        <div class="flex items-center justify-between px-2 py-2">
          <h2 class="font-semibold">ê¸°ë¡</h2>
          <div class="text-xs text-slate-500">ë”ë¸”íƒ­ ìˆ˜ì • / ğŸ—‘ ì‚­ì œ</div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left border-b border-slate-200/60">
                <th class="py-2 px-2">ë‚ ì§œ</th>
                <th class="px-2">ì‹¬ë³¼</th>
                <th class="px-2">ë°©í–¥</th>
                <th class="px-2">ì†ìµ</th>
                <th class="px-2">ê·¼ê±°</th>
                <th class="px-2"></th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </section>
    </section>

    <!-- Connect Page -->
    <section data-page="connect" class="hidden space-y-4">
      <div class="glass rounded-2xl p-4">
        <h1 class="text-lg font-semibold">ìë™ ë¶ˆëŸ¬ì˜¤ê¸°</h1>
        <p class="text-sm text-slate-500 mt-1">ê±°ë˜ì†Œë‘ ì—°ê²°í•´ì„œ ë§¤ë§¤ì¼ì§€ë¥¼ ìë™ìœ¼ë¡œ ì±„ì›Œìš” ğŸ”—</p>
      </div>

      <div class="glass rounded-2xl p-4">
        <h2 class="font-semibold mb-2">ê±°ë˜ì†Œ ì—°ë™</h2>
        <div class="bg-slate-50 border border-slate-200 rounded-xl p-6 text-center">
          <div class="text-4xl mb-3">ğŸš§</div>
          <div class="font-medium text-slate-700 mb-2">ê±°ë˜ì†Œ ìë™ ì—°ë™ ê¸°ëŠ¥ ì¤€ë¹„ì¤‘</div>
          <p class="text-sm text-slate-500">í˜„ì¬ëŠ” ìˆ˜ë™ìœ¼ë¡œ ë§¤ë§¤ ê¸°ë¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.<br>ìë™ ì—°ë™ ê¸°ëŠ¥ì€ ê³§ ì—…ë°ì´íŠ¸ ì˜ˆì •ì…ë‹ˆë‹¤.</p>
        </div>
      </div>

      <!-- ê°€ì… ë§í¬ ìƒ˜í”Œ -->
      <div class="glass rounded-2xl p-4">
        <h3 class="font-medium mb-3">ê±°ë˜ì†Œ ê°€ì… ë§í¬</h3>
        <div class="grid grid-cols-2 gap-3">
          <a href="https://partner.bybit.com/b/COINPNL" target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 p-3 rounded-xl border border-slate-200 hover:bg-slate-50 transition">
            <img src="bybit.png" alt="Bybit" class="h-8 w-auto" />
            <div class="flex-1">
              <div class="font-medium">Bybit ê°€ì…í•˜ê¸°</div>
              <div class="text-xs text-slate-500">ìˆ˜ìˆ˜ë£Œ 20% í˜ì´ë°± ì ìš©</div>
            </div>
            <span class="text-sm">â†—</span>
          </a>
          <a href="https://www.okx.com/join/coinpnl" target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 p-3 rounded-xl border border-slate-200 hover:bg-slate-50 transition">
            <img src="okx.png" alt="OKX" class="h-8 w-auto" />
            <div class="flex-1">
              <div class="font-medium">OKX ê°€ì…í•˜ê¸°</div>
              <div class="text-xs text-slate-500">ìˆ˜ìˆ˜ë£Œ 20% í˜ì´ë°± ì ìš©</div>
            </div>
            <span class="text-sm">â†—</span>
          </a>
          <a href="https://partner.bitget.com/bg/clyzvfex" target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 p-3 rounded-xl border border-slate-200 hover:bg-slate-50 transition">
            <img src="bitget.png" alt="Bitget" class="h-8 w-auto" />
            <div class="flex-1">
              <div class="font-medium">Bitget ê°€ì…í•˜ê¸°</div>
              <div class="text-xs text-slate-500">ìˆ˜ìˆ˜ë£Œ 20% í˜ì´ë°± ì ìš©</div>
            </div>
            <span class="text-sm">â†—</span>
          </a>
          <a href="https://bingx.com/invite/ZXOC75NH" target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 p-3 rounded-xl border border-slate-200 hover:bg-slate-50 transition">
            <img src="bingx.png" alt="BingX" class="h-8 w-auto" />
            <div class="flex-1">
              <div class="font-medium">BingX ê°€ì…í•˜ê¸°</div>
              <div class="text-xs text-slate-500">ìˆ˜ìˆ˜ë£Œ 20% í˜ì´ë°± ì ìš©</div>
            </div>
            <span class="text-sm">â†—</span>
          </a>
        </div>
      </div>
    </section>

    <!-- AI Page -->
    <section data-page="ai" class="hidden space-y-4">
      <div class="glass rounded-2xl p-4">
        <h1 class="text-lg font-semibold">AI ë¦¬í¬íŠ¸</h1>
        <p class="text-sm text-slate-500 mt-1">ë°ì´í„°ì—ì„œ ê¿€íŒì„ ë½‘ì•„ì£¼ëŠ” ì‘ì€ ì¡°ì–¸ê°€ ğŸ¤–ğŸ’¡</p>
      </div>

      <!-- í•µì‹¬ ì§€í‘œ ì¹´ë“œ 4ê°œ -->
      <div class="grid grid-cols-2 gap-3">
        <!-- ëˆ„ì  ìˆ˜ìµë¥  -->
        <div class="glass rounded-2xl p-4">
          <div class="text-2xl font-bold" id="aiTotalReturn">-</div>
          <div class="text-xs text-slate-500 mt-1">ëˆ„ì  ìˆ˜ìµë¥ </div>
          <div class="text-xs text-slate-400">ì´ˆê¸° ì‹œë“œ ëŒ€ë¹„</div>
        </div>

        <!-- ìµœëŒ€ ë‚™í­ (MDD) -->
        <div class="glass rounded-2xl p-4">
          <div class="text-2xl font-bold" id="aiMdd">-</div>
          <div class="text-xs text-slate-500 mt-1">ìµœëŒ€ ë‚™í­ (MDD)</div>
          <div class="text-xs text-slate-400">ìì‚°ê³¡ì„  ê¸°ì¤€ ìµœëŒ€ í•˜ë½</div>
        </div>

        <!-- ìƒ¤í”„ì§€ìˆ˜ -->
        <div class="glass rounded-2xl p-4">
          <div class="text-2xl font-bold" id="aiSharpe">-</div>
          <div class="text-xs text-slate-500 mt-1">ìƒ¤í”„ì§€ìˆ˜</div>
          <div class="text-xs text-slate-400">ì¼ìˆ˜ìµ ê¸°ì¤€ ì—°í™˜ì‚°</div>
        </div>

        <!-- ìŠ¹ë¥  -->
        <div class="glass rounded-2xl p-4">
          <div class="text-2xl font-bold" id="aiWinRate">-</div>
          <div class="text-xs text-slate-500 mt-1">ìŠ¹ë¥ </div>
          <div class="text-xs text-slate-400">ê±°ë˜ ë‹¨ìœ„</div>
        </div>
      </div>

      <!-- AI ì¸ì‚¬ì´íŠ¸ -->
      <div class="glass rounded-2xl p-4 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold">AI ì¸ì‚¬ì´íŠ¸</h2>
          <button id="regen" class="text-xs px-2 py-1 rounded-lg border border-slate-300">ì¬ìƒì„±</button>
        </div>
        <div id="insights" class="space-y-2"></div>
        <div class="pt-2 border-t border-slate-200/60">
          <h3 class="text-sm font-medium mb-1">ì¶”ì²œ ì•¡ì…˜</h3>
          <ul id="todos" class="list-disc list-inside text-sm space-y-1"></ul>
        </div>
      </div>
    </section>

    <!-- PnL Page -->
    <section data-page="pnl" class="hidden space-y-4">
      <div class="glass rounded-2xl p-4">
        <h1 class="text-lg font-semibold">ë‚´ ìì‚° íë¦„</h1>
        <p class="text-sm text-slate-500 mt-1">ìˆ˜ìµê³¼ ë“œë¡œìš°ë‹¤ìš´ì„ ê·¸ë˜í”„ë¡œ ì“±~ í™•ì¸ ğŸ“ˆ</p>
      </div>
      <div class="grid grid-cols-1 gap-4">
        <div class="glass rounded-2xl p-4">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold">ìì‚°ê³¡ì„  (Equity)</h2>
            <span class="text-xs text-slate-500" id="equitySummary"></span>
          </div>
          <canvas id="equityChart"></canvas>
        </div>
        <div class="glass rounded-2xl p-4">
          <h2 class="font-semibold">ì¼ì¼ ì†ìµ</h2>
          <canvas id="pnlChart"></canvas>
        </div>
        <div class="glass rounded-2xl p-4">
          <h2 class="font-semibold">ë“œë¡œìš°ë‹¤ìš´</h2>
          <canvas id="ddChart"></canvas>
        </div>
      </div>
    </section>

    <!-- Me Page -->
    <section data-page="me" class="hidden space-y-4">
      <div class="glass rounded-2xl p-4">
        <h1 class="text-lg font-semibold">ë‚´ ê³µê°„</h1>
        <p class="text-sm text-slate-500 mt-1">ë°ì´í„° ê´€ë¦¬ì™€ ì‹œì¥ ì§€í‘œë¥¼ í•œëˆˆì— ğŸ‘¤</p>
      </div>

      <div class="glass rounded-2xl p-4">
        <h2 class="font-semibold mb-3">ë°ì´í„° ê´€ë¦¬</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <button id="meExportXlsxBtn" class="px-4 py-3 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 transition-colors">
            ğŸ“Š ì—‘ì…€ ë‚´ë³´ë‚´ê¸° (.xlsx)
          </button>
          <button id="meBackupBtn" class="px-4 py-3 rounded-xl border border-slate-300 hover:bg-slate-50 transition-colors">
            ğŸ’¾ í´ë¼ìš°ë“œ ë°±ì—… (ì¤€ë¹„ì¤‘)
          </button>
        </div>
      </div>

      <!-- ì§€í‘œ í•œëˆˆì— ë³´ê¸° -->
      <div class="glass rounded-2xl p-4">
        <h3 class="font-medium mb-2">ì§€í‘œ í•œëˆˆì— ë³´ê¸°</h3>
        <div class="grid grid-cols-3 gap-3">
          <!-- USDT/KRW -->
          <div class="p-4 rounded-xl bg-slate-900 text-center text-white shadow">
            <div class="text-[11px] uppercase tracking-wide text-slate-400">USDT/KRW</div>
            <div id="usdtKrw" class="text-lg font-semibold transition-all duration-300 opacity-100">-</div>
          </div>
          <!-- BTC Dominance -->
          <div class="p-4 rounded-xl bg-slate-900 text-center text-white shadow">
            <div class="text-[11px] uppercase tracking-wide text-slate-400">BTC.D</div>
            <div id="btcDominance" class="text-lg font-semibold transition-all duration-300 opacity-100">-</div>
          </div>
          <!-- Fear & Greed -->
          <div class="p-4 rounded-xl bg-slate-900 text-center text-white shadow">
            <div class="text-[11px] tracking-wide text-slate-400">ê³µí¬Â·íƒìš• ì§€ìˆ˜</div>
            <div id="fearGreed" class="text-lg font-semibold transition-all duration-300 opacity-100">-</div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Bottom Tab Bar -->
  <nav id="tabbar" class="fixed bottom-0 inset-x-0 z-40 bg-white/90 border-t border-slate-200/60 backdrop-blur">
    <div class="max-w-3xl mx-auto px-2">
      <ul class="grid grid-cols-5 text-xs">
        <li><button class="w-full py-3 tab-item active" data-tab="journal">ğŸ“<div>ë§¤ë§¤ì¼ê¸°ì¥</div></button></li>
        <li><button class="w-full py-3 tab-item" data-tab="connect">ğŸ”—<div>ì—°ë™</div></button></li>
        <li><button class="w-full py-3 tab-item" data-tab="ai">ğŸ¤–<div>AI ë¦¬í¬íŠ¸</div></button></li>
        <li><button class="w-full py-3 tab-item" data-tab="pnl">ğŸ“ˆ<div>ìì‚° ë¦¬í¬íŠ¸</div></button></li>
        <li><button class="w-full py-3 tab-item" data-tab="me">ğŸ‘¤<div>ë‚´ ë©”ë‰´</div></button></li>
      </ul>
    </div>
  </nav>

  <!-- Floating Action Button -->
  <button id="fab" class="fab fixed bottom-16 right-6 z-50 p-4 rounded-full bg-emerald-600 text-white hover:scale-105 transition-transform">ï¼‹</button>

  <script>
    // ===== Local State Keys =====
    const KEY_SETTINGS = 'dj_settings_v1';
    const KEY_ENTRIES  = 'dj_entries_v1';
    const KEY_AUTH     = 'dj_auth_v1';
    const KEY_API_LINKS= 'dj_api_links_v1';

    let settings = { ccy:'USDT', initialEquity:10000, mddLimit:null };
    let entries = [];
    let auth = null;
    let apiLinks = {};

    function saveSettings(){ localStorage.setItem(KEY_SETTINGS, JSON.stringify(settings)); }
    function saveEntries(){ localStorage.setItem(KEY_ENTRIES, JSON.stringify(entries)); }
    function saveAuth(){ localStorage.setItem(KEY_AUTH, JSON.stringify(auth)); }
    function saveApiLinks(){ localStorage.setItem(KEY_API_LINKS, JSON.stringify(apiLinks)); }

    (function load(){
      try{ const s=localStorage.getItem(KEY_SETTINGS); if(s) settings=JSON.parse(s);}catch{}
      try{ const e=localStorage.getItem(KEY_ENTRIES); if(e) entries=JSON.parse(e);}catch{}
      try{ const a=localStorage.getItem(KEY_AUTH); if(a) auth=JSON.parse(a);}catch{}
      try{ const l=localStorage.getItem(KEY_API_LINKS); if(l) apiLinks=JSON.parse(l);}catch{}
    })();

    // ===== Utils =====
    const $ = (id) => document.getElementById(id);
    const today = () => new Date().toISOString().slice(0,10);
    const fmt = (n, ccy) => new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 2 }).format(n) + (ccy? ' ' + ccy : '');
    
    // Privacy mode
    let privacyMode = false;
    const maskText = (text) => text.replace(/[\d,\.]/g, '*');
    
    function togglePrivacyMode() {
      privacyMode = !privacyMode;
      const btn = $('togglePrivacy');
      btn.textContent = privacyMode ? 'ğŸ™ˆ' : 'ğŸ‘ï¸';
      updateEquityHeader();
      updateAIStats();
      rebuildTable();
    }
    
    $('togglePrivacy')?.addEventListener('click', togglePrivacyMode);


	// ticker helpers
    const DEFAULT_TICKERS = ['BTC/USDT','ETH/USDT','SOL/USDT','XRP/USDT','BNB/USDT'];
    function populateTickerList(){ const dl=$('tickerList'); if(!dl) return; dl.innerHTML = DEFAULT_TICKERS.map(t=>`<option value="${t}">`).join(''); }
    function normalizeTicker(s){ 
      if(!s) return '';
      s = s.trim().toUpperCase().replace(/[-_]/g,'/').replace(/\s+/g,'');
      // ALUSDT í˜•íƒœë¥¼ AL/USDTë¡œ ìë™ ë³€í™˜
      if(!s.includes('/') && s.length > 4){
        const commonQuotes = ['USDT','USDC','BTC','ETH','KRW','BUSD'];
        for(const quote of commonQuotes){
          if(s.endsWith(quote)){
            const base = s.slice(0, -quote.length);
            if(base.length >= 2){ // ìµœì†Œ 2ê¸€ì ì´ìƒì˜ ë² ì´ìŠ¤ ì½”ì¸
              return base + '/' + quote;
            }
          }
        }
      }
      return s;
    }

    // daily aggregation & equity series
    function aggregateDaily(){ const map=new Map(); for(const e of entries){ const k=e.date; map.set(k,(map.get(k)||0)+Number(e.pnl)); } return [...map.entries()].map(([d,pnl])=>({d,pnl})).sort((a,b)=>a.d.localeCompare(b.d)); }
    function computeEquitySeries(daily){
      let equity=Number(settings.initialEquity||0);
      const eq=[]; let peak=equity; let mdd=0; const ddSeries=[];
      for(const x of daily){
        equity+=Number(x.pnl);
        eq.push({d:x.d,e:equity});
        peak=Math.max(peak,equity);
        const dd=peak>0?(equity-peak)/peak:0;
        ddSeries.push({d:x.d,dd});
        mdd=Math.min(mdd,dd);
      }
      return {eq,ddSeries,mdd};
    }

    // ===== AI Stats Calculation =====
    function computeAIStats() {
      const daily = aggregateDaily();
      if (daily.length === 0) {
        return { totalReturn: 0, mdd: 0, sharpe: 0, winRate: 0 };
      }

      const { eq, ddSeries, mdd } = computeEquitySeries(daily);
      
      // 1. Total Return (ì´ˆê¸° ì‹œë“œ ëŒ€ë¹„ ìˆ˜ìµë¥ )
      const initial = Number(settings.initialEquity || 0);
      const final = eq.length > 0 ? eq[eq.length - 1].e : initial;
      const totalReturn = initial > 0 ? ((final - initial) / initial) * 100 : 0;

      // 2. MDD (ì´ë¯¸ ê³„ì‚°ë¨)
      const mddPct = mdd * 100;

      // 3. Sharpe Ratio (ì¼ì¼ ìˆ˜ìµë¥  ê¸°ì¤€, ì—°í™˜ì‚°)
      const returns = daily.map(d => d.pnl / initial);
      const avgReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
      const variance = returns.reduce((sum, r) => sum + Math.pow(r - avgReturn, 2), 0) / returns.length;
      const stdDev = Math.sqrt(variance);
      const sharpe = stdDev > 0 ? (avgReturn / stdDev) * Math.sqrt(252) : 0; // ì—°í™˜ì‚°

      // 4. Win Rate (ìŠ¹ë¥ )
      const wins = entries.filter(e => Number(e.pnl) > 0).length;
      const total = entries.length;
      const winRate = total > 0 ? (wins / total) * 100 : 0;

      return { totalReturn, mdd: mddPct, sharpe, winRate };
    }

    function updateAIStats() {
      const stats = computeAIStats();
      
      const returnText = stats.totalReturn.toFixed(1) + '%';
      $('aiTotalReturn').textContent = privacyMode ? maskText(returnText) : returnText;
      $('aiTotalReturn').className = 'text-2xl font-bold ' + (stats.totalReturn >= 0 ? 'text-emerald-600' : 'text-rose-500');
      
      const mddText = stats.mdd.toFixed(1) + '%';
      $('aiMdd').textContent = privacyMode ? maskText(mddText) : mddText;
      $('aiMdd').className = 'text-2xl font-bold text-rose-500';
      
      const sharpeText = stats.sharpe.toFixed(2);
      $('aiSharpe').textContent = privacyMode ? maskText(sharpeText) : sharpeText;
      $('aiSharpe').className = 'text-2xl font-bold ' + (stats.sharpe >= 1 ? 'text-emerald-600' : 'text-slate-900');
      
      const winRateText = stats.winRate.toFixed(0) + '%';
      $('aiWinRate').textContent = privacyMode ? maskText(winRateText) : winRateText;
      $('aiWinRate').className = 'text-2xl font-bold ' + (stats.winRate >= 50 ? 'text-emerald-600' : 'text-slate-900');
    }

    // ===== Exchange Link (Demo) - ì¤€ë¹„ì¤‘ =====
    // ê±°ë˜ì†Œ ì—°ë™ ê¸°ëŠ¥ì€ ë°±ì—”ë“œ ì„œë²„ê°€ í•„ìš”í•˜ë¯€ë¡œ í˜„ì¬ ë¹„í™œì„±í™”

    // ===== Table render =====
    let KRW_PER_USDT = null; // í™˜ìœ¨ ì €ì¥ (í…Œì´ë¸” KRW íŒíŠ¸/í—¤ë” ê³„ì‚°ìš©)
    function rebuildTable(){
      const tbody=$('rows'); if(!tbody) return; tbody.innerHTML='';
      const sorted=[...entries].sort((a,b)=>b.date.localeCompare(a.date));
      for(const e of sorted){
        const pnlDisplay = isFinite(e.pnl) ? (e.pnl >= 0 ? '+' + e.pnl : e.pnl) : '';
        const pnlMasked = privacyMode ? maskText(String(pnlDisplay)) : pnlDisplay;
        
        let krwHint = '';
        if (settings.ccy === 'USDT' && KRW_PER_USDT && isFinite(e.pnl)) {
          const krwValue = fmt(e.pnl * KRW_PER_USDT, 'KRW');
          krwHint = `<div class="text-[11px] text-slate-500">â‰ˆ ${privacyMode ? maskText(krwValue) : krwValue}</div>`;
        }
        
        const tr=document.createElement('tr');
        tr.className='border-b border-slate-200/50';
        tr.dataset.id=e.id;
        tr.innerHTML = `
          <td class='py-2 px-2'>${e.date||''}</td>
          <td class='px-2'>${e.symbol||''}</td>
          <td class='px-2'>${e.side||''}</td>
          <td class='px-2 ${e.pnl>=0?'text-emerald-600':'text-rose-500'} font-medium'>${pnlMasked}${krwHint}</td>
          <td class='px-2 max-w-[240px] truncate' title='${e.reason??''}'>${e.reason??''}</td>
          <td class='px-2'><button class='text-xs underline' data-del='${e.id}'>ğŸ—‘</button></td>`;
        tbody.appendChild(tr);
      }
    }
    $('rows')?.addEventListener('click',(e)=>{
      const id=e.target.dataset.del; if(!id) return;
      entries=entries.filter(x=>x.id!==id);
      saveEntries();
      rebuildTable();
      refreshCharts();
      updateEquityHeader();
      updateAIStats();
    });

    // ===== Charts =====
    let equityChart,pnlChart,ddChart;
    function refreshCharts(){
      const daily=aggregateDaily();
      const { eq, ddSeries, mdd } = computeEquitySeries(daily);
      
      // ì›”ë³„ë¡œ 1~31ì¼ê¹Œì§€ ì „ì²´ ë‚ ì§œ ìƒì„±
      const monthlyLabels = [];
      const monthlyPnl = [];
      const monthlyEquity = [];
      const monthlyDD = [];
      
      if (daily.length > 0) {
        // ê°€ì¥ ìµœê·¼ ì›”ì„ ê¸°ì¤€ìœ¼ë¡œ
        const lastDate = new Date(daily[daily.length - 1].d);
        const year = lastDate.getFullYear();
        const month = lastDate.getMonth(); // 0-11
        
        // í•´ë‹¹ ì›”ì˜ 1ì¼ë¶€í„° ë§ˆì§€ë§‰ ë‚ ê¹Œì§€
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          monthlyLabels.push(`${month + 1}/${day}`);
          
          // í•´ë‹¹ ë‚ ì§œì˜ ë°ì´í„° ì°¾ê¸°
          const dailyData = daily.find(d => d.d === dateStr);
          const eqData = eq.find(e => e.d === dateStr);
          const ddData = ddSeries.find(dd => dd.d === dateStr);
          
          monthlyPnl.push(dailyData ? dailyData.pnl : null);
          monthlyEquity.push(eqData ? eqData.e : null);
          monthlyDD.push(ddData ? (ddData.dd * 100).toFixed(2) : null);
        }
      }
      
      const tot=daily.reduce((a,b)=>a+b.pnl,0);
      const ret=settings.initialEquity?(eq.length? (eq.at(-1).e/settings.initialEquity - 1):0):0;
      $('equitySummary').textContent =
        `ëˆ„ì  ${fmt(tot, settings.ccy)} / ìˆ˜ìµë¥  ${(ret*100).toFixed(2)}% / MDD ${(mdd*100).toFixed(2)}%`;

      for(const c of [equityChart,pnlChart,ddChart]){ if(c) c.destroy(); }
      
      equityChart=new Chart($('equityChart'),{
        type:'line',
        data:{
          labels: monthlyLabels,
          datasets:[{
            label:'Equity',
            data: monthlyEquity,
            borderWidth:2,
            pointRadius:3,
            tension:0.25,
            fill:true,
            spanGaps:true
          }]
        },
        options:{
          plugins:{legend:{display:false}},
          scales:{
            x:{ticks:{maxTicksLimit:31}},
            y:{beginAtZero:false}
          }
        }
      });
      
      pnlChart=new Chart($('pnlChart'),{
        type:'bar',
        data:{
          labels: monthlyLabels,
          datasets:[{
            label:'PnL',
            data: monthlyPnl,
            backgroundColor: monthlyPnl.map(v => v === null ? 'transparent' : (v >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(244, 63, 94, 0.8)')),
            borderColor: monthlyPnl.map(v => v === null ? 'transparent' : (v >= 0 ? 'rgb(16, 185, 129)' : 'rgb(244, 63, 94)')),
            borderWidth: 1
          }]
        },
        options:{
          plugins:{legend:{display:false}},
          scales:{
            x:{ticks:{maxTicksLimit:31}}
          }
        }
      });
      
      ddChart=new Chart($('ddChart'),{
        type:'bar',
        data:{
          labels: monthlyLabels,
          datasets:[{
            label:'Drawdown(%)',
            data: monthlyDD
          }]
        },
        options:{
          plugins:{legend:{display:false}},
          scales:{
            x:{ticks:{maxTicksLimit:31}},
            y:{ticks:{callback:v=>v+'%'}}
          }
        }
      });
    }

    // ===== Header (Net/Initial) =====
    function updateEquityHeader(){
      const initialValue = Number(settings.initialEquity || 0);
      const initialText = fmt(initialValue, settings.ccy);
      $('initialEquityView').textContent = privacyMode ? maskText(initialText) : initialText;
      
      const tot = entries.reduce((a,b)=> a + Number(b.pnl||0), 0);
      const net = initialValue + tot;

      // USDT/KRW í™˜ì‚° ë³´ì¡°í‘œì‹œ
      let netText = fmt(net, settings.ccy);
      let html = privacyMode ? maskText(netText) : netText;
      
      if (settings.ccy === 'USDT' && KRW_PER_USDT){
        const netKrw = net * KRW_PER_USDT;
        const krwText = fmt(netKrw, 'KRW');
        html += `<div class="text-xs text-slate-500">â‰ˆ ${privacyMode ? maskText(krwText) : krwText}</div>`;
      }
      $('netEquity').innerHTML = html;
    }

    // ===== Form handlers =====
    $('tickerPreset').addEventListener('change',(e)=>{ const v=e.target.value; if(v && v!=='__custom'){ $('symbol').value=v; } if(v==='__custom'){ $('symbol').focus(); } });
    $('entryForm').addEventListener('submit',(e)=>{
      e.preventDefault();
      const sym=normalizeTicker($('symbol').value || $('tickerPreset').value);
      if(!sym){ alert('í‹°ì»¤ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: BTC/USDT)'); return; }
      const entry={
        id:crypto.randomUUID(),
        date:$('date').value,
        symbol:sym,
        side:$('side').value,
        pnl:Number($('pnl').value),
        reason:$('reason').value.trim()
      };
      entries.push(entry);
      saveEntries();
      rebuildTable();
      refreshCharts();
      updateEquityHeader();
      updateAIStats();
      resetForm();
    });
    function resetForm(){ $('date').value=today(); $('tickerPreset').value=''; $('symbol').value=''; $('side').value='LONG'; $('pnl').value=''; $('reason').value=''; }
    $('clearForm').addEventListener('click', resetForm);

    // ===== Settings =====
    $('saveSettings').addEventListener('click',()=>{
      settings.ccy=$('ccy').value;
      settings.initialEquity=Number($('initialEquity').value||0);
      saveSettings();
      refreshCharts();
      rebuildTable();
      updateEquityHeader();
      updateAIStats();
    });
    function hydrateSettings(){ $('ccy').value=settings.ccy||'USDT'; $('initialEquity').value=settings.initialEquity??''; }

    // ===== Excel Export =====
    function exportToExcel(){
      if(!window.XLSX){ alert('ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì˜¤ë¥˜'); return; }
      const daily=aggregateDaily();
      const { eq, ddSeries, mdd } = computeEquitySeries(daily);

      const wb=XLSX.utils.book_new();

      const wsEntries = XLSX.utils.json_to_sheet(
        entries.map(e=>({
          ë‚ ì§œ:e.date,
          ì‹¬ë³¼:e.symbol,
          ë°©í–¥:e.side,
          ì†ìµê¸ˆ:e.pnl,
          ì†ìµê¸ˆ_KRW:(settings.ccy==='USDT'&&KRW_PER_USDT&&isFinite(e.pnl))
            ? Math.round(e.pnl*KRW_PER_USDT*100)/100 : '',
          ë§¤ë§¤ê·¼ê±°:e.reason
        }))
      );
      XLSX.utils.book_append_sheet(wb, wsEntries, 'Entries');

      const wsDaily=XLSX.utils.json_to_sheet(
        daily.map(d=>({
          ë‚ ì§œ:d.d,
          ì¼ì¼ì†ìµ:d.pnl,
          ì¼ì¼ì†ìµ_KRW:(settings.ccy==='USDT'&&KRW_PER_USDT)
            ? Math.round(d.pnl*KRW_PER_USDT*100)/100 : ''
        }))
      );
      XLSX.utils.book_append_sheet(wb, wsDaily, 'DailyPnL');

      const wsEq=XLSX.utils.json_to_sheet(
        eq.map((r,i)=>({
          ë‚ ì§œ:r.d,
          ìì‚°:r.e,
          ë“œë¡œìš°ë‹¤ìš´í¼ì„¼íŠ¸:Number((ddSeries[i].dd*100).toFixed(2))
        }))
      );
      XLSX.utils.book_append_sheet(wb, wsEq, 'Equity');

      const tot=daily.reduce((a,b)=>a+b.pnl,0);
      const ret=settings.initialEquity?(eq.length? (eq.at(-1).e/settings.initialEquity - 1):0):0;
      const stats = computeAIStats();
      const wsSummary=XLSX.utils.json_to_sheet([{
        ê¸°ì¤€í†µí™”:settings.ccy,
        ì´ˆê¸°ìë³¸:settings.initialEquity,
        ëˆ„ì ì†ìµ:tot,
        ëˆ„ì ì†ìµ_KRW:(settings.ccy==='USDT'&&KRW_PER_USDT)
          ? Math.round(tot*KRW_PER_USDT*100)/100 : '',
        ìˆ˜ìµë¥ í¼ì„¼íŠ¸:Number((ret*100).toFixed(2)),
        ëˆ„ì ìˆ˜ìµë¥ í¼ì„¼íŠ¸:Number(stats.totalReturn.toFixed(2)),
        MDDí¼ì„¼íŠ¸:Number(stats.mdd.toFixed(2)),
        ìƒ¤í”„ì§€ìˆ˜:Number(stats.sharpe.toFixed(2)),
        ìŠ¹ë¥ í¼ì„¼íŠ¸:Number(stats.winRate.toFixed(2)),
        í™˜ìœ¨_ì¶œì²˜:'CoinGecko (USDTâ†’KRW)'
      }]);
      XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');

      XLSX.writeFile(wb, `coinpnl_${new Date().toISOString().slice(0,10)}.xlsx`);
    }
    $('exportXlsxBtn').addEventListener('click', exportToExcel);
    $('meExportXlsxBtn')?.addEventListener('click', exportToExcel);

    // ===== Backup Button (Demo) =====
    $('meBackupBtn')?.addEventListener('click', ()=>{
      alert('í´ë¼ìš°ë“œ ë°±ì—… ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.\ní˜„ì¬ëŠ” ì—‘ì…€ ë‚´ë³´ë‚´ê¸°ë¡œ ë°ì´í„°ë¥¼ ë°±ì—…í•˜ì„¸ìš”!');
    });

    // ===== AI Insights Generator =====
    function generateInsights() {
      const stats = computeAIStats();
      const insights = [];
      const todos = [];

      if (entries.length < 10) {
        insights.push('ğŸ“Š ë°ì´í„°ê°€ ë¶€ì¡±í•´ìš”. ìµœì†Œ 10ê°œ ì´ìƒì˜ ê±°ë˜ë¥¼ ê¸°ë¡í•˜ë©´ ë” ì •í™•í•œ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        todos.push('ë§¤ë§¤ ê¸°ë¡ì„ ê¾¸ì¤€íˆ ë‚¨ê²¨ë³´ì„¸ìš”');
      } else {
        if (stats.totalReturn > 20) {
          insights.push(`ğŸ‰ ëˆ„ì  ìˆ˜ìµë¥  ${stats.totalReturn.toFixed(1)}%! í›Œë¥­í•œ ì„±ê³¼ì…ë‹ˆë‹¤.`);
        } else if (stats.totalReturn > 0) {
          insights.push(`âœ… ëˆ„ì  ìˆ˜ìµë¥  ${stats.totalReturn.toFixed(1)}%. ê¾¸ì¤€íˆ ê¸°ë¡í•˜ê³  ê°œì„ í•´ë³´ì„¸ìš”.`);
        } else {
          insights.push(`âš ï¸ ìˆ˜ìµë¥ ì´ ë§ˆì´ë„ˆìŠ¤ì…ë‹ˆë‹¤. ì†ì‹¤ íŒ¨í„´ì„ ë¶„ì„í•´ë³´ì„¸ìš”.`);
          todos.push('ì†ì‹¤ ê±°ë˜ë“¤ì˜ ê³µí†µì ì„ ì°¾ì•„ë³´ì„¸ìš”');
        }

        if (stats.mdd < -20) {
          insights.push(`ğŸš¨ MDD ${stats.mdd.toFixed(1)}%ë¡œ ë†’ìŠµë‹ˆë‹¤. ë¦¬ìŠ¤í¬ ê´€ë¦¬ê°€ í•„ìš”í•´ìš”.`);
          todos.push('í¬ì§€ì…˜ ì‚¬ì´ì¦ˆë¥¼ ì¤„ì—¬ë³´ì„¸ìš”');
        } else if (stats.mdd < -10) {
          insights.push(`âš ï¸ MDD ${stats.mdd.toFixed(1)}%. ì ì ˆí•œ ìˆ˜ì¤€ì´ì§€ë§Œ ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.`);
        } else {
          insights.push(`âœ… MDD ${stats.mdd.toFixed(1)}%ë¡œ ì–‘í˜¸í•©ë‹ˆë‹¤.`);
        }

        if (stats.sharpe >= 2) {
          insights.push(`ğŸ† ìƒ¤í”„ì§€ìˆ˜ ${stats.sharpe.toFixed(2)}! ìœ„í—˜ ëŒ€ë¹„ ìˆ˜ìµì´ ìš°ìˆ˜í•©ë‹ˆë‹¤.`);
        } else if (stats.sharpe >= 1) {
          insights.push(`ğŸ‘ ìƒ¤í”„ì§€ìˆ˜ ${stats.sharpe.toFixed(2)}. ì•ˆì •ì ì¸ ìˆ˜ìµ êµ¬ì¡°ì…ë‹ˆë‹¤.`);
        } else if (stats.sharpe >= 0) {
          insights.push(`ğŸ“ˆ ìƒ¤í”„ì§€ìˆ˜ ${stats.sharpe.toFixed(2)}. ë³€ë™ì„± ëŒ€ë¹„ ìˆ˜ìµì„ ê°œì„ í•´ë³´ì„¸ìš”.`);
          todos.push('ìˆ˜ìµì€ í‚¤ìš°ê³  ë³€ë™ì„±ì€ ì¤„ì—¬ë³´ì„¸ìš”');
        } else {
          insights.push(`âš ï¸ ìƒ¤í”„ì§€ìˆ˜ê°€ ìŒìˆ˜ì…ë‹ˆë‹¤. ì „ëµ ì¬ì ê²€ì´ í•„ìš”í•©ë‹ˆë‹¤.`);
        }

        if (stats.winRate >= 60) {
          insights.push(`ğŸ¯ ìŠ¹ë¥  ${stats.winRate.toFixed(0)}%! ë†’ì€ ìŠ¹ë¥ ì„ ìœ ì§€í•˜ê³  ìˆì–´ìš”.`);
        } else if (stats.winRate >= 50) {
          insights.push(`âœ… ìŠ¹ë¥  ${stats.winRate.toFixed(0)}%. ì†ìµë¹„ë¥¼ í•¨ê»˜ ì²´í¬í•´ë³´ì„¸ìš”.`);
          todos.push('í‰ê·  ìˆ˜ìµ í¬ê¸°ì™€ í‰ê·  ì†ì‹¤ í¬ê¸°ë¥¼ ë¹„êµí•´ë³´ì„¸ìš”');
        } else {
          insights.push(`ğŸ“‰ ìŠ¹ë¥  ${stats.winRate.toFixed(0)}%. ìŠ¹ë¥ ì´ ë‚®ë‹¤ë©´ ì†ìµë¹„ë¥¼ ë†’ì—¬ì•¼ í•©ë‹ˆë‹¤.`);
          todos.push('ì†ì ˆì€ ë¹ ë¥´ê²Œ, ìµì ˆì€ ì¶©ë¶„íˆ ê°€ì ¸ê°€ë³´ì„¸ìš”');
        }
      }

      // ë Œë”ë§
      const insightsEl = $('insights');
      insightsEl.innerHTML = insights.map(i => `<div class="text-sm p-2 rounded-lg bg-slate-50">${i}</div>`).join('');

      const todosEl = $('todos');
      todosEl.innerHTML = todos.map(t => `<li class="text-slate-700">${t}</li>`).join('') || '<li class="text-slate-400">í˜„ì¬ ì¶”ì²œ ì•¡ì…˜ì´ ì—†ìŠµë‹ˆë‹¤</li>';
    }

    $('regen')?.addEventListener('click', generateInsights);

    // ===== Indicators (USDT/KRW, BTC.D, F&G) =====
    function smoothUpdate(elId, nextText) {
      const el = $(elId);
      if (!el) return;
      if (el.textContent === nextText) return;
      el.style.transform = 'translateY(4px)';
      el.style.opacity = '0';
      setTimeout(() => {
        el.textContent = nextText;
        el.style.transform = 'translateY(0)';
        el.style.opacity = '1';
      }, 160);
    }
    async function fetchIndicatorsOnce() {
      try {
        // 1) USDTâ†’KRW (CoinGecko)
        const res1 = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=tether&vs_currencies=krw');
        const js1 = await res1.json();
        const krw = js1?.tether?.krw ?? null;
        if (krw != null) {
          KRW_PER_USDT = krw;
          smoothUpdate('usdtKrw', new Intl.NumberFormat('ko-KR').format(krw));
          updateEquityHeader();
          rebuildTable();
        }

        // 2) BTC Dominance (CoinGecko Global)
        const res2 = await fetch('https://api.coingecko.com/api/v3/global');
        const js2 = await res2.json();
        const btcDom = js2?.data?.market_cap_percentage?.btc;
        if (typeof btcDom === 'number') {
          smoothUpdate('btcDominance', btcDom.toFixed(2) + '%');
        }

        // 3) Fear & Greed (Alternative.me)
        const res3 = await fetch('https://api.alternative.me/fng/');
        const js3 = await res3.json();
        const fg = js3?.data?.[0]?.value ?? null;
        if (fg != null) {
          smoothUpdate('fearGreed', String(fg));
        }
      } catch (err) {
        console.error('ì§€í‘œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', err);
      }
    }
    let _indicatorsTimer = null;
    function startIndicators() {
      fetchIndicatorsOnce();
      if (_indicatorsTimer) clearInterval(_indicatorsTimer);
      _indicatorsTimer = setInterval(fetchIndicatorsOnce, 60 * 1000);
    }

    // ===== Tabs & FAB =====
    const tabs = document.querySelectorAll('.tab-item');
    function switchTab(tab){
      tabs.forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('[data-page]').forEach(p=>p.classList.add('hidden'));
      document.querySelector(`[data-page="${tab}"]`).classList.remove('hidden');
      document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
      
      // AI íƒ­ìœ¼ë¡œ ì „í™˜ì‹œ ì¸ì‚¬ì´íŠ¸ ìƒì„±
      if (tab === 'ai') {
        generateInsights();
      }
    }
    tabs.forEach(t=>t.addEventListener('click', ()=> switchTab(t.dataset.tab)));
    $('fab').addEventListener('click', ()=>{ switchTab('journal'); $('entryForm').scrollIntoView({behavior:'smooth', block:'start'}); });

    // ===== Service Worker (ì˜µì…˜) =====
    if ('serviceWorker' in navigator) { window.addEventListener('load', ()=>{ navigator.serviceWorker.register('service-worker.js').catch(()=>{}); }); }

    // ===== Init =====
    (function init(){
      $('date').value = today();
      populateTickerList();
      hydrateSettings();
      rebuildTable();
      refreshCharts();
      updateEquityHeader();
      updateAIStats();
      generateInsights();
      wireExchangeButtons();
      markExchangeLinked();
      startIndicators();
      switchTab('journal');
    })();
  </script>
</body>
</html>